// https://www.typescriptlang.org/play?#code/JYOwLgpgTgZghgYwgAkWYB7EAeAKnKAcwjABpkAlCAZwFcAbMAPmQG8BYAKGWQAowCxMAC5k+IiXJQaDEZRmMAlKIBuGYABMuAXy5dQkWIhQIsG4OizQ8gkiw7c+AiXPFDlyAEYYM9CHBAdPU4wAE8ABxQASRAYaABBBEsQNxI8FgBeMWQIAA9IEA1qVCTMHFA4qDFyCuhKFgB+bNEQCBVoLjDI5BjKxOSqOkZ05CzcHPyIQuK0Muxaqtwa2LqKRspkFraOzn1waHgkZChaEFmsbC4eeImCopLk7ADQ8memUiuxWzBbqfvehKlLCpMDYeKZHorKD9MogsHvLj2T68c4gUTxDy8CCiEGKUYsKhgWhQFIRCDwoK7TgGA7GY4QBDE6gYKCXRw3PJ3GZAnDPV4gUIIxwg37TSF9Hlw8GjcWA5JSpiItjIgB0asE1FEAAUCHAALYkaDUeGYk5nHmiLE4754jIsNSaW0EkjE0mRCmcXRUmlGI5URlQZmsz4AIR89FF928vn8IA+jjDvgAYqcEJHirw1SqNaJngBtAC6Tq84dj8euPPTfCzOdQAsLxb5nwAwmYLGUq4mIwAfZBdlMgBDlyinVFVzPqoiauuhBv46uTwjT-NF+dNxz+pks8c1qe5+uru0L7N7mdzo-rnitwrtqxVTl-DPOISiAHQyXfME8pjF6N+ALDpugbAO047PiQr5QjCwKftBIDvMgMDAH405vnBgyyF+yQ-vODoaIBDJMigD5ivw3yQRK8qwd+UgKHIaE8hhwxwThR4oha8gBtQIEQMWeHxkijiouiPLDqYN7JKI17mMkw5msJI7mrJnzSFxLKiEBQZiW2yTQFJOllDsPCqUyPEaYRwHtCpFnUNinFEZSXAIPQcDUMUmkstgXbkP2qbkHB5DSbecaKai5AeVAgUGXe4U2TxsVcRApCCTw4nUGAJxJCyvCfDw4S0J49DAGmCkBblyD5YVxXIOJMllPpEllMOeUFUVabyRxFCjqJ5WVW19JqVA5mDcOeKsMgXqfLVwV1FkvBkS4xYODwPDADAThkhg61gAAFsA1AqtNySjBkWQAER-rGZ1jeVxkuiSyC7fth3RYEjg8NoOT0LZ9JEg9T0HUdZQLe4nzaHirnIEFulQMEd1cTxozlfNIOSPSQxgEtt3IGtTh7YDr3QKjmN4gDKomYGEDE7RGOKPw+Pk3F7SKNjZOotT6OyCz70TYoEPuUzEBwwNRFIzz83gWQnNKPi2PsckWM8ytj0MxTQYc9ItP089HXJPLZR89j4OoALiXBJN1L7L6KARbgZLFMtyCEFAcBIcIl7HJotAAF5lMA7sCsOepwBlxX+x7BAuyAhDAPqUzoMIjupRgep6rQAi+1g-tJytkRQGnGeGQHLysy71DhBg3GZ60xfNStzLpRYPt+7X2NQBghdZ8X5Vesrph6p4oBwNXdk5zwGi0OEbUh3ArdK8gpzFbPHvKyooCmC5AjdzzvcTY5VIAPRH0fXDHyfnBnwfp9n9fx+3+fl-31fF83y-d9vw-r+Px-z-f3-r9cBgKmY6UcNAp14DdRw0g-ogGQAAWRDjtcmGBTgaF4Ag3a5MAhgL1BA5AAAqZAABGAADGQ8hJDFAqjABgAAyqHaOvAADMAAmbmFtnKuWKLQlOKBHYAGJ9oABFgBDRLDGAInwzgGlEOlKAoBCCfCQihUQPCDSFmQL2EADB6BTSwHI2gWUoC8GEaI0Ql0AKIWQjQBoqjeFzhzmTQR1ARFVCyKY2GPMybSJQFkUB4DubK2UTQZATQybBOKFkCJmwVbPWiVkbR9BdGOF3h4hkNCoChDwTnaBrpYkHWca4sG+80o-CsDKVoAB3ZAaiqbwG+rxJy+ifhgEqRgCpEBqm1N4PU2y3NSkqzccgKpNTeE9LgA0-pzTEIoI6V0sZvTGmcAGUhFQczRkGn4CcJKyA8wjO6YsxQ5B9kLImX045nSNlUwyrQHZezLkHLObxIsRYmkgHSlYwMPwEkPLGTcu5VhyCtIwECnakUZm0HIKs15yzpkRNkQwwgGisiFmCAMhSqJsC1PIHIhRhYIQ9Osa8KALtQiNhJXAUIKp8rUB2oSvwKofHczeR8oGd5RBstaKyWpBLgnFmCSqNJRisnMthe8n4ut6rHG6o8LoEAtoPDKAS1ExYsSNh5FiKF1jqCioGWrdSItAyeTlQq1EmRkTBOJaS1VkqsD8usSqCJABCR1LIACiiA6W2pAKKkZEUcpCR6o4Tl0A5IyqatZEaXAqFqx4oSr5WqUK6v0TGFU9AMCEHpTQRQQA
type InferArrayType<A> = A extends Array<infer X> ? X : never;

interface ArrayReduceCallback<
  P extends Array<any>,
  T extends InferArrayType<P> = InferArrayType<P>
> {
  (previousValue: T, currentValue: T, currentIndex: number, array: P): T;
}

type InferActionTarget<T> = T extends action<infer T, infer R> ? T : never;
type InferActionResult<T> = T extends action<infer T, infer R> ? R : never;

export interface action<Target, Result> {
  (target: Target, result: Result): void;
}

export interface conditioner<Target> {
  (target: Target): boolean;
}

export interface runaction<
  A extends action<any, any>,
  Target extends InferActionTarget<A> = InferActionTarget<A>
> {
  (action: A): (e: Target) => ReturnType<A>;
}

export interface recursor<
  A extends action<any, any>,
  Target extends InferActionTarget<A> = InferActionTarget<A>
> {
  (...args: Parameters<A>): (runaction: (e: Target) => void) => ReturnType<A>;
}

export interface Recursor<
  Bool extends boolean,
  BoolFunc extends (...args: any[]) => boolean,
  Action extends (...args: any[]) => any,
  Condition extends Bool | BoolFunc,
  Runaction extends (...args: any[]) => (...args: any[]) => any,
  Recursor extends (...args: any[]) => (...args: any[]) => any,
  Conditioner extends (target: InferActionTarget<Action>) => boolean,
  PerformRecursion extends (
    target: InferActionTarget<Action>,
    files: InferActionResult<Action>
  ) => void,
  ExecuteRecursor extends (
    target: InferActionTarget<Action>,
    result: InferActionResult<Action>
  ) => (action: PerformRecursion) => void
> {
  action: Action;
  condition: Condition;
  runaction: Runaction;
  recursor: Recursor;
  conditioner: Conditioner;
  performRecursion: PerformRecursion;
  executeRecursor: ExecuteRecursor;
}

export class Recursor<
  Bool,
  BoolFunc,
  Action,
  Condition,
  Runaction,
  Recursor,
  Conditioner,
  PerformRecursion,
  ExecuteRecursor
> {
  constructor(
    public action: Action,
    public condition: Condition,
    public runaction: Runaction,
    public recursor: Recursor
  ) {}

  conditioner = ((target) => {
    if (typeof this.condition === "boolean") return this.condition;
    else return this.condition(target);
  }) as Conditioner;

  performRecursion = ((target, result) => {
    if (this.conditioner(target))
      this.executeRecursor(target, result)(this.performRecursion);
    this.action(target, result);
  }) as PerformRecursion;

  result: InferActionResult<Action> | undefined;
  executeRecursor = ((target, result) => (action) => {
    this.result = result;
    this.recursor(target, result)(this.runaction(action));
  }) as ExecuteRecursor;
}

interface RecursorTypes {
  grafi: any;
  riduzioni: any;
  matrici: any;
  arrangiamenti: {
    commutazioni: {
      permutazione: any;
      trasposizione: any;
      sostituzioni: any;
      rotazioni: any;
      riflessione: any;
      scambi: any;
    };
    combinazione: {
      duplicata: any;
      unica: any;
      vincolata: any;
    };
  };
}
